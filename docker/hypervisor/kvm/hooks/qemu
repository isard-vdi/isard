#!/bin/bash
# ============================================================================
# Qemu Hook - Sends events to OVS worker daemon via Unix socket
# ============================================================================
# This hook is called by libvirt on VM lifecycle events.
# It sends a JSON request to the OVS worker daemon and exits immediately,
# avoiding blocking libvirt while OVS operations are processed.
#
# The OVS worker daemon handles event coalescing and smart processing.
# ============================================================================
#
# Libvirt Hook Arguments (from https://libvirt.org/hooks.html):
#   $1 = guest name (or '-' if none)
#   $2 = operation: prepare, start, started, stopped, release, migrate, restore, reconnect
#   $3 = sub-operation: begin, end (or '-')
#   $4 = extra argument (shutdown reason for 'release', or '-')
#
# Hook Invocations:
# ┌────────────────────────────────┬──────────┬───────┬────────────────────┐
# │ When                           │ $2       │ $3    │ $4                 │
# ├────────────────────────────────┼──────────┼───────┼────────────────────┤
# │ Before resource preparation    │ prepare  │ begin │ -                  │
# │ After labeling, before launch  │ start    │ begin │ -                  │
# │ After QEMU process starts      │ started  │ begin │ -                  │
# │ Before shutdown cleanup        │ stopped  │ end   │ -                  │
# │ After resource cleanup         │ release  │ end   │ <shutoff-reason>   │
# │ Incoming migration             │ migrate  │ begin │ -                  │
# │ Restore from saved image       │ restore  │ begin │ -                  │
# │ Libvirt daemon reconnect       │ reconnect│ begin │ -                  │
# └────────────────────────────────┴──────────┴───────┴────────────────────┘
#
# Events we handle:
#   started  -> Add OVS flows
#   stopped  -> Delete OVS flows
#   migrate  -> Add OVS flows (incoming migration destination)
#   restore  -> Add OVS flows (restored from saved image)
#   reconnect-> Reapply OVS flows
#
# NOTE: Pause/resume (virsh suspend/resume) do NOT trigger hooks.
#       OVS flows remain in place during pause, which is correct behavior.
#
# IMPORTANT: Do NOT call virsh from this hook - it would deadlock libvirtd
# (libvirt waits for hook to complete, hook waits for libvirt)
# ============================================================================

SOCKET=/var/run/openvswitch/ovs-worker.sock

domain_name="$1"
operation="$2"
sub_operation="$3"

# Read XML from stdin immediately (must be consumed)
XML=$(cat -)

# Determine what action to take based on operation
case "${operation}" in
    started)
        status="started"
        ;;
    stopped)
        status="stopped"
        ;;
    migrate|restore)
        status="started"
        ;;
    reconnect)
        status="reconnect"
        ;;
    *)
        # prepare, start, release - we don't need to act
        exit 0
        ;;
esac

# Send event to OVS worker daemon via Unix socket
# Use timeout to ensure we never block libvirt for more than 2 seconds
timeout 2 python3 -c "
import socket
import json
import sys
import os
from datetime import datetime

domain = '$domain_name'
status = '$status'
operation = '$operation'
timestamp = $(date +%s%3N)
xml_data = sys.stdin.read()
sock_path = '$SOCKET'
hyper_id = os.environ.get('HYPER_ID', 'unknown')

def log_json(event, **kwargs):
    \"\"\"Print JSON log to stdout for docker logs\"\"\"
    msg = {
        'type': 'qemu_hook',
        'sysid': hyper_id,
        'time': datetime.now().astimezone().isoformat(),
        'event': event,
        'domain': domain,
        'operation': operation,
        'status': status,
        **kwargs
    }
    print(json.dumps(msg), flush=True)

# Check if socket exists before attempting connection
if not os.path.exists(sock_path):
    log_json('worker_not_running')
    sys.exit(0)

request = {
    'domain': domain,
    'status': status,
    'timestamp': timestamp,
    'xml': xml_data
}

sock = socket.socket(socket.AF_UNIX, socket.SOCK_STREAM)
try:
    sock.settimeout(1)
    sock.connect(sock_path)
    sock.sendall(json.dumps(request).encode())
    log_json('sent')
except Exception as e:
    log_json('error', error=str(e))
finally:
    sock.close()
" <<< "$XML"

# ALWAYS exit 0 - never block libvirt
exit 0
