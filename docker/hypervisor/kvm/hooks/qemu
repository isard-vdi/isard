#!/bin/bash
# ============================================================================
# Qemu Hook - Sends events to OVS worker daemon via Unix socket
# ============================================================================
# This hook is called by libvirt on VM lifecycle events.
# It sends a JSON request to the OVS worker daemon and exits immediately,
# avoiding blocking libvirt while OVS operations are processed.
#
# The OVS worker daemon handles event coalescing and smart processing.
# ============================================================================
#
# Libvirt Hook Arguments (from https://libvirt.org/hooks.html):
#   $1 = guest name (or '-' if none)
#   $2 = operation: prepare, start, started, stopped, release, migrate, restore, reconnect
#   $3 = sub-operation: begin, end (or '-')
#   $4 = extra argument (shutdown reason for 'release', or '-')
#
# Hook Invocations:
# ┌────────────────────────────────┬──────────┬───────┬────────────────────┐
# │ When                           │ $2       │ $3    │ $4                 │
# ├────────────────────────────────┼──────────┼───────┼────────────────────┤
# │ Before resource preparation    │ prepare  │ begin │ -                  │
# │ After labeling, before launch  │ start    │ begin │ -                  │
# │ After QEMU process starts      │ started  │ begin │ -                  │
# │ Before shutdown cleanup        │ stopped  │ end   │ -                  │
# │ After resource cleanup         │ release  │ end   │ <shutoff-reason>   │
# │ Incoming migration             │ migrate  │ begin │ -                  │
# │ Restore from saved image       │ restore  │ begin │ -                  │
# │ Libvirt daemon reconnect       │ reconnect│ begin │ -                  │
# └────────────────────────────────┴──────────┴───────┴────────────────────┘
#
# Events we handle:
#   started  -> Add OVS flows (if domstate=running, skip if paused)
#   stopped  -> Delete OVS flows
#   migrate  -> Add OVS flows (incoming migration destination)
#   restore  -> Add OVS flows (restored from saved image)
#   reconnect-> Reapply OVS flows
#
# ============================================================================

SOCKET=/var/run/openvswitch/ovs-worker.sock

domain_name="$1"
operation="$2"
sub_operation="$3"

# Read XML from stdin immediately (must be consumed)
XML=$(cat -)

# Determine what action to take based on operation
case "${operation}" in
    started)
        # QEMU process started - check if START_PAUSED (test start)
        state=$(virsh domstate "$domain_name" 2>/dev/null)
        [ "$state" = "paused" ] && exit 0
        status="started"
        ;;
    stopped)
        status="stopped"
        ;;
    migrate|restore)
        # Incoming migration or restore - VM should be running
        state=$(virsh domstate "$domain_name" 2>/dev/null)
        [ "$state" = "paused" ] && exit 0
        status="started"
        ;;
    reconnect)
        status="reconnect"
        ;;
    *)
        # prepare, start, release - we don't need to act
        exit 0
        ;;
esac

# Send event to OVS worker daemon via Unix socket
python3 -c "
import socket
import json
import sys

request = {
    'domain': '$domain_name',
    'status': '$status',
    'timestamp': $(date +%s%3N),
    'xml': sys.stdin.read()
}

sock = socket.socket(socket.AF_UNIX, socket.SOCK_STREAM)
try:
    sock.settimeout(5)  # 5 second timeout
    sock.connect('$SOCKET')
    sock.sendall(json.dumps(request).encode())
    sock.shutdown(socket.SHUT_WR)
    response = sock.recv(1024)  # Wait for ACK
except Exception as e:
    # Log error but don't block libvirt
    print(f'OVS worker error: {e}', file=sys.stderr)
finally:
    sock.close()
" <<< "$XML"

exit 0
