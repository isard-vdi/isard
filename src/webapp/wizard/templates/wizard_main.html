<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <!-- Meta, title, CSS, favicons, etc. -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Installation | Isard</title>
    <link rel="icon" type="image/png" href="favicon-32x32.png" sizes="32x32" />
    <link rel="icon" type="image/png" href="favicon-16x16.png" sizes="16x16" />
    
    <!-- Bootstrap -->
    <link href="/vendors/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="/vendors/font-awesome/css/font-awesome.min.css" rel="stylesheet">
    <!-- jquery smart wizard -->
    <link href="/vendors/jQuery-Smart-Wizard/styles/demo_style.css" rel="stylesheet" type="text/css">
    <link href="/vendors/jQuery-Smart-Wizard/styles/smart_wizard.css" rel="stylesheet" type="text/css">

<style type="text/css">
    body {
		font-family: 'Varela Round', sans-serif;
	}
	.modal-login {		
		color: #636363;
		width: 610px;
	}
	.modal-login .modal-content {
		padding: 20px;
		border-radius: 5px;
		border: none;
	}
	.modal-login .modal-header {
		border-bottom: none;   
        position: relative;
        justify-content: center;
	}
	.modal-login h4 {
		text-align: center;
		font-size: 26px;
		margin: 30px 0 -15px;
	}
	.modal-login .form-control:focus {
		border-color: #70c5c0;
	}
	.modal-login .form-control, .modal-login .btn {
		min-height: 40px;
		border-radius: 3px; 
	}
	.modal-login .close {
        position: absolute;
		top: -5px;
		right: -5px;
	}	
	.modal-login .modal-footer {
		background: #ecf0f1;
		border-color: #dee4e7;
		text-align: center;
        justify-content: center;
		margin: 0 -20px -20px;
		border-radius: 5px;
		font-size: 13px;
	}
	.modal-login .modal-footer a {
		color: #999;
	}		
	.modal-login .avatar {
		position: absolute;
		margin: 0 auto;
		left: 0;
		right: 0;
		top: -70px;
		width: 95px;
		height: 95px;
		border-radius: 50%;
		z-index: 9;
		background: #60c7c1;
		padding: 15px;
		box-shadow: 0px 2px 2px rgba(0, 0, 0, 0.1);
	}
	.modal-login .avatar img {
		width: 100%;
	}
	.modal-login.modal-dialog {
		margin-top: 80px;
	}
    .modal-login .btn {
        color: #fff;
        border-radius: 4px;
		background: #60c7c1;
		text-decoration: none;
		transition: all 0.1s;
        line-height: normal;
        border: none;
    }
	.modal-login .btn:hover, .modal-login .btn:focus {
		background: #45aba6;
		outline: none;
	}
	.trigger-btn {
		display: inline-block;
		margin: 100px auto;
	}
  
</style>

  </head>

  <body>
    <div class="demoHead">   
      <div>
        <div style="float:left;">
          <h1>IsardVDI</h1>
          <h2>installation wizard</h2>
        </div>
        <div style="float:right;" class="demoNavLinks">
          <a href="https://isardvdi.readthedocs.io/en/latest/" class="btn"  target="_blank">Documentation</a>
          <a href="https://github.com/isard-vdi/isard-docker" class="btn"  target="_blank">Github</a>
        </div>
        <div style="clear:both;"></div>
      </div>

    </div>

    <table align="center" border="0" cellpadding="0" cellspacing="0">
        <tr><td> 
            <div id="wizard" class="swMain">
              <ul>
                <li><a href="#step-1">
                      <label class="stepNumber">1</label>
                      <span class="stepDesc">
                         Configuration<br />
                         <small>isard.conf file</small>
                      </span>
                  </a></li>
                <li><a href="#step-2">
                      <label class="stepNumber">2</label>
                      <span class="stepDesc">
                         Database<br />
                         <small>RethinkDB service</small>
                      </span>
                  </a></li>
                <li><a href="#step-3">
                      <label class="stepNumber">3</label>
                      <span class="stepDesc">
                         Password<br />
                         <small>Protect admin account</small>
                      </span>
                  </a></li>    
<!--
                <li><a href="#step-4">
                      <label class="stepNumber">4</label>
                      <span class="stepDesc">
                         Connection<br />
                         <small>Internet connection</small>
                      </span>                   
                   </a></li>
-->
                <li><a href="#step-4">
                      <label class="stepNumber">4</label>
                      <span class="stepDesc">
                         Engine<br />
                         <small>Backend engine</small>                          
                      </span>                   
                  </a></li>
                <li><a href="#step-5">
                      <label class="stepNumber">5</label>
                      <span class="stepDesc">
                         Hypervisor<br />
                         <small>Available hypervisors</small>
                      </span>                   
                  </a></li>
                <li><a href="#step-6">
                      <label class="stepNumber">6</label>
                      <span class="stepDesc">
                         Updates<br />
                         <small>Media and config updates</small>
                      </span>                   
                  </a></li>
              </ul>
              <div id="step-1" style="height:370px">   
                  <h2 class="StepTitle">Step 1. Configuration file</h2>
                   <!-- step content -->
              </div>
              <div id="step-2" style="height:370px">
                  <h2 class="StepTitle">Step 2 Content</h2> 
                   <!-- step content -->
              </div>                      
              <div id="step-3" style="height:370px">
                  <h2 class="StepTitle">Step 3. Set admin user password</h2> 
                   <!-- step content -->
              </div>
<!--
              <div id="step-4" style="height:370px">
-->
<!--
                  <h2 class="StepTitle">Step 4 Connection</h2>   
-->
                   <!-- step content -->                         
<!--
              </div>
-->
              <div id="step-4" style="height:370px">
                  <h2 class="StepTitle">Step 4 Engine</h2>   
                   <!-- step content -->                         
              </div> 
              <div id="step-5" style="height:370px">
                  <h2 class="StepTitle">Step 5 Hypervisor</h2>   
                   <!-- step content -->                         
              </div>             
              <div id="step-6" style="height:370px">
                  <h2 class="StepTitle">Step 6 Updates</h2>   
                   <!-- step content -->                         
              </div> 
            </div>
        </td></tr>
    </table>
</body>

<div id="registerModal" class="modal fade"  >
	<div class="modal-dialog modal-login">
		<div class="modal-content">
			<div class="modal-header">
				<div class="avatar">
					<img src="/img/isard_logo.png" alt="Avatar">
				</div>				
				<h4 class="modal-title">Wellcome to IsardVDI install wizard</h4>	
<!--
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
-->
			</div>
			<div class="modal-body">
                    <textarea rows="16" cols="55" id="aboutDescription"  style="resize: none; round" disabled>
                    GNU AFFERO GENERAL PUBLIC LICENSE
                       Version 3, 19 November 2007

 Copyright (C) 2007 Free Software Foundation, Inc. <http://fsf.org/>
 Everyone is permitted to copy and distribute verbatim copies
 of this license document, but changing it is not allowed.  
 
 THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.                  
                    </textarea>
				<form>
<!--
					<div class="form-group">
						<input type="checkbox" checked >Accept terms & conditions</button>
                    </div>
-->
                    <div class="form-group">
                        <input id="reg" name="reg" type="checkbox" checked >Get demonstration domains</button>
					</div>                    
					<div class="form-group">
						<button id="send-reg" type="button" class="btn btn-primary btn-lg btn-block login-btn">Start!</button>
					</div>
				</form>
			</div>
<!--
			<div class="modal-footer">
				<a href="#">Forgot Password?</a>
			</div>
-->
		</div>
	</div>
</div>  


<div class="modal fade" id="passwdModal" tabindex="-1" role="dialog" 
     aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <!-- Modal Header -->
            <div class="modal-header">   
                <button type="button" class="close" 
                   data-dismiss="modal">
                       <span aria-hidden="true">&times;</span>
                       <span class="sr-only">Close</span>
                </button>
                <h4 class="modal-title">
                    </i> <i class="fa fa-lock"> </i> Update password
                </h4>
            </div>

            <!-- Modal Body -->
            <div class="modal-body">

                <div class="row">
                  <div class="col-md-12 col-sm-12 col-xs-12">
                    <div class="x_panel">
                      <div class="x_title">
                        <h2>Update admin user password</h2>
                        <div class="clearfix"></div>
                      </div>
                      <div class="x_content">
                        <form name="Form" id="changepw" class="form-horizontal form-label-left"
                          data-parsley-excluded="input[type=button], input[type=submit], input[type=reset], input[type=hidden], [disabled], :hidden"
                          data-parsley-trigger="keyup" data-parsley-validate>
                          <div>
                                  <input id="password1" name="password" type="password" class="form-control col-md-7 col-xs-12 password"
                                    placeholder="New password"
                                    data-parsley-minlength="8"
                                    data-parsley-errors-container=".errorspannewpassinput"
                                    data-parsley-required-message="Please enter your new password."
                                    data-parsley-uppercase="1"
                                    data-parsley-lowercase="1"
                                    data-parsley-number="1"
                                    data-parsley-special="1"
                                    data-parsley-required 
                                    autofocus />
                                  <span class="errorspannewpassinput"></span>
                          </div>
                          <div>
                                  <input name="Password_2" id="password2" type="password" class="form-control col-md-7 col-xs-12 password"
                                  placeholder="Repeat password"
                                    data-parsley-minlength="8"
                                    data-parsley-errors-container=".errorspanconfirmnewpassinput"
                                    data-parsley-required-message="Please re-enter your new password."
                                    data-parsley-equalto="#password1"
                                    data-parsley-required />
                                  <span class="errorspanconfirmnewpassinput"></span>
                          </div>
                          <div>
                            <button type="submit" class="btn btn-default submit">Update</button>
                          </div>
                        </form>           

                        <br />
                      </div>
                    </div>
                  </div>
                </div>

            </div>
        </div>
    </div>
</div>
      
    <!-- jQuery -->
    <script src="/vendors/jquery/dist/jquery.min.js"></script>
    <!-- Bootstrap -->
    <script src="/vendors/bootstrap/dist/js/bootstrap.js"></script>    
<!--
    <script type="text/javascript" src="jquery-1.4.2.min.js"></script>
-->
    <script type="text/javascript" src="/vendors/jQuery-Smart-Wizard/js/jquery.smartWizard.js"></script>
<!--
     Parsley 
-->
    <script src="/vendors/parsleyjs/dist/parsley.min.js"></script>

<script type="text/javascript">
var skip_internet=false;
var skip_hypervisor=false;
function skipInternet(){
    skip_internet=true;
}
function skipHypervisor(){
    skip_hypervisor=true;
    $('#wizard').smartWizard('goToStep', 6);
}
$(document).ready(function(){
    // Smart Wizard  
    
            //~ $('#registerModal').dialog('open');

    $("#passwdModal").on("shown.bs.modal", function() {
        $(this).find("#password1").focus()
    });

    $('#wizard').smartWizard({
        contentURL:'/content',
        contentCache:false,
        onLeaveStep:leaveAStepCallback,
        //~ onShowStep: showStepCallback,
        onFinish:onFinishCallback,
        transitionEffect: 'slide'
    });

    function setErrors(){
        $.post( "/errors", function( data ) {
            var data = JSON.parse(data);
            $.each(data,function(i,d){ 
                $("#wizard").smartWizard('setError', d); 
            });
            return data;
        });
        
    }
    //~ var errors=setErrors()

        function setError(stepnumber){
            $("#wizard").smartWizard('setError',{stepnum:stepnumber,iserror:true});
        }    
    //~ $("#wizard").smartWizard('showMessage', 'Hello, World!');

    
    function leaveAStepCallback(obj, context){
        //~ alert("Leaving step " + context.fromStep + " to go to step " + context.toStep);
        if(context.fromStep==5){updateHypervisor();}

        //~ if(context.fromStep==4 && skip_internet){setError(4); return true;}
        if(context.fromStep==5 && skip_hypervisor){setError(5); return true;}
        if(validateSteps(context.fromStep)=='true'){
            return true;
        }else{
            $("#wizard").smartWizard('goToStep', context.fromStep);
            return false};
        //~ return validateSteps(context.fromStep); // return false to stay on step and true to continue navigation 
    }

    function onFinishCallback(objs, context){
        //~ console.log('finish click')
        if(validateAllSteps()){
            result = $.ajax({
                    type: "POST",
                    url: "/shutdown",
                    async: false
                }).responseText; 
            shutdown()
            //~ window.location.replace('/');
            //~ console.log('all steps valid')
            //~ $('form').submit();
        }
    }

    // Your Step validation logic
    function validateSteps(stepnumber){
        return $.ajax({
            type: "POST",
            url: "/validate/"+stepnumber,
            async: false
        }).responseText;
    }
    
    function validateAllSteps(){
        var isStepValid = true;
        // all step validation logic     
        return isStepValid;
    }  
    
    //~ function showStepCallback(obj, context){  
            //~ result= $.ajax({
                //~ type: "POST",
                //~ url: "/content",
                //~ data: {'step_number':context.toStep},
                //~ async: false
            //~ }).responseText;
        //~ $('#step-'+context.toStep).html(result);
        //~ alert('Content shown');
        //~ alert("Leaving step " + context.fromStep + " to go to step " + context.toStep);
    //~ }  
    
    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }
            async function shutdown() {
              await sleep(2000);
              window.location.replace('/');
            }

});
</script>
<script>
    // STEP 2 DATABASE
    function createDB()
    {
        promise = changeDiv().then(waitForDB());
    }
    function changeDiv()
    {
        d = new $.Deferred();
        $('#populate-div').hide();
        $('#populating-div').show();
        return d.promise()
    }
    function waitForDB()
    {
        d = new $.Deferred();
        result=$.ajax({
            type: "POST",
            url: "/create_db",
            timeout: 60000,
            async: true
        }).responseText;
        //~ if(result=='true'){$('#populate').hide();}
        $('#wizard').smartWizard('goToStep', 2);        
        return d.promise()
    }
    
    // STEP 1 CONFIG
    function createCONFIG(cfg){
           result=$.ajax({
                type: "POST",
                url: "/create_config",
                data: JSON.stringify(cfg),
                async: false
            }).responseText;
            $('#wizard').smartWizard('goToStep', 1);
    } 
	
    // STEP 4 HYPERVISOR
	function updateHypervisor(){
		response= $.ajax({
                    type: "POST",
                    url: "/hypervisor_address",
                    async: false,
                    data: JSON.stringify(window.location.hostname),
                    contentType: "application/json; charset=utf-8",
                    traditional: true,
                    //~ success: function (data) {
                        //~ $("#changepw").reset();
                        //~ $("#registerModal").modal('hide');
                    //~ }                    
                });	    
	}
</script>
<script>
$(document).ready(function(){
   
			$('#registerModal').modal({
				backdrop: 'static',
				keyboard: false
			}).modal('show');
            
    $("#send-reg").on('click', function(e) {
        //~ console.log($('#reg').val())
        if ($('#reg').is(":checked"))
        {
          reg=true;
        }else{
          reg=false;
        }
            response= $.ajax({
                    type: "POST",
                    url: "/register",
                    async: false,
                    data: JSON.stringify(reg),
                    contentType: "application/json; charset=utf-8",
                    traditional: true,
                    success: function (data) {
                        //~ $("#changepw").reset();
                        $("#registerModal").modal('hide');
                    }                    
                });
        e.preventDefault();

      });    
    
    $("#changepw").parsley();
    $("#changepw").on('submit', function(e) {
        var f = $(this);
        f.parsley().validate();

        if (f.parsley().isValid()) {
            response= $.ajax({
                    type: "POST",
                    url: "/passwd",
                    async: false,
                    data: JSON.stringify($('#password1').val()),
                    contentType: "application/json; charset=utf-8",
                    traditional: true,
                    success: function (data) {
                        //~ $("#changepw").reset();
                        $("#passwdModal").modal('hide');
                        $('#wizard').smartWizard('goToStep', 3);
                    }                    
                });
        }

        e.preventDefault();
      });

    
});   
</script>
</html>
